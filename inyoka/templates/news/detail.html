{%- extends 'news/base.html' %}
{% from 'utils/macros.html' import render_form %}
{% set title_trace = [article.title] %}

{% block content %}
  <div class="article">
    <h3 class="title"><a href="{{ href(article) }}">{{ article.title }}</a></h3>
    <p class="meta">
      <span class="published">
        {%- trans author_url=href(article.author.profile), author_name=article.author.username,
                article_pubdate=article.updated|dateformat, article_pubtime=article.updated|timeformat('short') -%}
        written by <a href="{{ author_url }}">{{ author_name }}</a> on {{ article_pubdate }} {{ article_pubtime }}
        {% endtrans %}
      </span>
      <span class="tags">{% for tag in article.tags %}<a href="{{ href('news/index', slug=tag.slug) }}">{{ tag.name }}</a>{% if not loop.last %}, {% endif %}{% endfor %}</span>
      <span class="comments"><a href="{{ href(article, _anchor='comments') }}">
        {% if article.comment_count %}
        {% trans count=article.comment_count, human_count=article.comment_count|humanize|capitalize %}
        {{ human_count }} Comment{% pluralize %}{{ human_count }} Comments
        {% endtrans %}
        {% else %}
        {{ _('No Comments') }}
        {% endif %}
      </a></span>
      {# TODO: ACL check #}
      <span class="visits">{% trans count=article.view_count %}{{ count }} visit{% pluralize %}{{ count }} visits{% endtrans %}</span>
      <span class="admin"><a href="{{ href(article, action='edit') }}" class="adminlink">{{ _('edit') }}</a></span>
    </p>
    <div class="intro">{{ article.rendered_intro|safe }}</div>
    <div class="text">{{ article.rendered_text|safe }}</div>
    {%- if article.comments_enabled %}
    <span class="description">{% if article.comment_count %}
                              {% trans count=article.comment_count, human_count=article.comment_count|humanize|capitalize %}
                              {{ human_count }} Comment{% pluralize %}{{ human_count }} Comments
                              {% endtrans %}
                              {% else %}
                              {{ _('No Comments') }}
                              {% endif %}</span>
    <ol class="comments">
    {%- for comment in comments %}
    <li id="comment_{{ comment.id }}"
        class="{{ loop.cycle('odd', 'even') -}}
               {%- if comment.author_id == request.user.id %} owned{% endif -%}
               {%- if comment.deleted %} hidden{% endif -%}">
      <a href="{{ href(comment.author.profile) }}" class="comment_author">{{ comment.author.display_name }}</a>
      <img src="{{ href('static', file='img/no_avatar.png') }}" class="avatar" />
      <span class="meta">
        <span class="written">{{ comment.pub_date|dateformat }} @ {{ comment.pub_date|timeformat('short') }}</span>
        <a href="{{ href(comment) }}">#</a>
        <a href="{{ href(comment, action='edit') }}" class="adminlink action action_edit">{{ _('edit') }}</a> |
        {%- if comment.deleted %}
        <a href="{{ href(comment, action='restore') }}" class="adminlink action action_restore">{{ _('restore') }}</a>
        {%- else %}
        <a href="{{ href(comment, action='hide') }}" class="adminlink action action_hide">{{ _('hide') }}</a>
        {%- endif -%}
      </span>


      <div class="text">
        {{ comment.rendered_text|safe }}
      </div>
    </li>
    {%- endfor %}
    </ol>
    <div class="new_comment">
      {{ render_form(form) }}
    </div>
    {%- endif %}
    <p>
      {% if not request.user.subscribed('news.comments.by_entry', article.id) %}
      <a href="{{ href(article, action='subscribe') }}">subscribe</a>
      {% else %}
      <a href="{{ href(article, action='unsubscribe') }}">unsubscribe</a>
      {% endif %}
    </p>
  </div>
{% endblock %}
